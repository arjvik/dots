#!/bin/bash

BATTERY="BAT0"
FULL=70
LOW=30
CRITICAL=20

warn() {
	if [[ -z "$2" ]]; then
		rofi -dmenu -p "Warning" -lines 1 <<<"$1"
	else
		timeout 30s rofi -dmenu -p "Warning" -lines 2 -format i <<<"$1"$'\n'"$2"
	fi
}

while true; do
	CHARGE=$(cat "/sys/class/power_supply/$BATTERY/capacity")
	STATUS=$(cat "/sys/class/power_supply/$BATTERY/status")
	if [[ $STATUS == "Discharging" ]]; then
		if [[ $CHARGE -le $CRITICAL ]]; then
			# Discharging, 8% or lower
			[[ $(warn "Battery Critical ($CHARGE%)! Suspending now" "Don't suspend") -eq 1 ]] || i3lock-color-fancy suspend
		elif [[ $CHARGE -le $LOW ]]; then
			# Discharging, 20% or lower
			warn "Battery Low ($CHARGE%)"
		fi # else: Discharging normally, more than 20%
	else
		if [[ $CHARGE -ge $FULL ]]; then
			# Charging, at 100%
			warn "Battery Full ($CHARGE%)"
		fi # else: Charging normally
	fi
	sleep 30s
done
